1000 REM AM9511.BAS
1010 REM
1020 REM INTERFACE WITH AM9511 CHIP (EMULATOR)
1030 REM THIS IS *NOT* PRODUCTION CODE -- JUST PROOF OF CONCEPT
1040 REM THIS SHOULD BE ENOUGH TO WRITE A TEST SEQUENCE FOR BOTH
1050 REM EMULATOR AND ACTUAL CHIP
1060 REM
1070 GOSUB 1530 ' AM9511 -> X
1080 GOSUB 1300 ' X -> AM9511
1090 GOSUB 1240 ' WAIT FOR NOT BUSY
1100 GOSUB 1450 ' PUSH 0D/0.0
1110 GOSUB 1490 ' PUSH 0S
1120 AM.STATUS = &H51
1130 AM.DATA = &H50
1140 X = 0!
1150 REM
1160 REM MAIN
1170 GOSUB 1240
1180 OUT AM.STATUS,&H0
1190 GOSUB 1240
1200 S = INP(AM.STATUS) : PRINT "STATUS = "; HEX$(S)
1210 STOP
1220 REM WAIT FOR AM9511 NOT BUSY
1230 REM
1240 WAIT AM.STATUS,&H80,&H80
1250 RETURN
1260 REM PUSH MS FLOAT TO AM9511 STACK
1270 REM 
1280 REM INCOMING FLOAT IS IN VARIABLE X
1290 REM
1300 P = VARPTR(X)
1310 IF PEEK(P + 3) = 0 THEN 1450
1320 S = PEEK(P + 2) AND &H80
1330 E = PEEK(P + 3) - 129
1340 M.H = PEEK(P + 2) OR &H80
1350 M.LL = PEEK(P + 1)
1360 M.HL = PEEK(P + 0)
1370 E = (E + 1) AND &H7F
1380 OUT AM.DATA,M.LL
1390 OUT AM.DATA,M.HL
1400 OUT AM.DATA,M.H
1410 OUT AM.DATA,E
1420 RETURN
1430 REM
1440 REM WRITE 00 00 00 00 (ZERO) TO CHIP
1450 OUT AM.DATA,0
1460 OUT AM.DATA,0
1470 REM
1480 REM WRITE 0 (ZERO) TO CHIP
1490 OUT AM.DATA,0
1500 OUT AM.DATA,0
1510 RETURN
1520 REM POP FLOAT FROM AM9511 STACK, RETURN IN X
1530 B3 = INP(AM.DATA)
1540 B2 = INP(AM.DATA)
1550 B1 = INP(AM.DATA)
1560 B0 = INP(AM.DATA)
1570 X = 0
1580 IF (B2 AND &H80) = 0 THEN RETURN
1590 S = B3 AND &H80
1600 E = B3 AND &H7F
1610 M.H = B2
1620 M.LL = B0
1630 M.LH = B1
1640 E = E + 129
1650 M.H = M.H AND &H7F
1660 M.H = M.H OR S
1670 P = VARPTR(X)
1680 POKE P + 0,M.LL
1690 POKE P + 1,M.LH
1700 POKE P + 3,E
1710 RETURN
AND &H7F
1660 M.H =